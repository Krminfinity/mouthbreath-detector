# 口呼吸検出システム 要件定義書

作成日: 2025年10月3日

## 1. 背景と目的

* **目的**：PCのマイク/カメラからユーザーの呼吸様式を推定し、「口呼吸の可能性が高い状態」を通知・記録することで、習慣改善やヘルスケアに役立てる。
* **目的**：PCのWebカメラからユーザーの呼吸様式（口開き）を推定し、「口呼吸の可能性が高い状態」を通知・記録することで、習慣改善やヘルスケアに役立てる。
* **狙い**：①リアルタイム検出 ②低侵襲・低負荷 ③プライバシー配慮 ④継続利用を促すUI/フィードバック。
* **狙い**：①リアルタイム検出 ②低侵襲・低負荷 ③プライバシー配慮 ④継続利用を促すUI/フィードバック（Pythonベースでクロスプラットフォーム対応）。

## 2. 対象ユーザー/利用シーン

* **対象**：在宅ワーカー/ゲーマー/学習者/いびき傾向者/鼻炎持ち等、PC作業中の呼吸習慣を把握したい人。
* **利用シーン**：作業しながら常駐、口呼吸が続いたら軽くリマインド、日/週で傾向を可視化。

## 3. スコープ

* **MVP**：

  * Webカメラ映像から顔ランドマークを抽出し、**口開き状態（口呼吸疑い）**をリアルタイムに検出（確信度/連続時間で判定）。
  * デスクトップ通知、簡易タイムライン/日次集計。
  * ローカル保存、プライバシー設定（映像・画像の保存ON/OFF、保存しないモード）。

* **拡張**（Phase2以降）：
  * **音響情報**（マイク入力）とのハイブリッド判定。
  * 個人適応（キャリブレーション）/機械学習モデル更新。
  * いびき/無呼吸兆候の夜間モード（将来）。
  * ガイダンス（鼻呼吸トレーニング/姿勢コーチ）。

## 4. プラットフォーム/環境

* **OS**：Windows 10/11（優先）、macOS/Linuxも対応可能。
* **ハード**：PC内蔵or外付けWebカメラ。
* **実行形態**：Pythonアプリ（ウィンドウ最小化・バックグラウンド動作可）。
* **オフライン**：基本オフライン動作。モデル/辞書はローカル。

## 5. 主要ユーザーストーリー

1. 「作業中、**口呼吸が30秒以上**続いたら**静かに通知**してほしい」
2. 「**日/週ごと**に口呼吸時間と割合を**グラフ**で見たい」
3. 「会議中/配信中は**検出を一時停止**したい」
4. 「**録音データは保存せず**特徴量のみ保存したい」
5. 「自分の環境に合わせて**感度/しきい値**を調整したい」

## 6. 機能要件（MVP）

### 6.1 データ取得

* Webカメラ映像の**連続ストリーミング取得**（顔検出、ランドマーク抽出）。
* **プライバシーモード**：
  * A: 映像・画像**未保存**（特徴量のみ）
  * B: **数秒リングバッファ**保存（デバッグ/学習向け、既定OFF）
* 入力デバイス選択/カメラテスト。

### 6.2 検出アルゴリズム（カメラベース）

* **顔ランドマーク抽出**（例：Dlib/Mediapipe等）
* **口開き指標**（MAR: Mouth Aspect Ratio、唇上下距離/顔サイズ比）
* **口開きスコア**：ルールベースまたは軽量分類器（例：しきい値判定＋小規模DNN/SVM）でフレーム毎スコア化。
* **時間統合**：移動窓で連続性判定、**「口呼吸状態」**ラベルを出力。
* **学習なしでも動く初期ルール**を実装（MARしきい値/持続性）。
* **感度設定**：低/標準/高＋カスタムしきい値。

### 6.3 通知/フィードバック

* **リアルタイムインジケータ**（トレイアイコン色/小ウィジェット）。
* **リアルタイムインジケータ**（小型ウィンドウやステータスバー表示）。
* **条件通知**：

  * 例）スコア≥Tが**連続30秒**以上でポップアップ通知（win10toast等）
  * 連続発火防止（クールダウン設定）。

* **サマリー画面**：

  * 当日：総モニタ時間／口呼吸推定時間／割合／イベント回数
  * 時系列：10分粒度ヒートマップ/折れ線（matplotlib, plotly等）。

### 6.4 設定/制御

* 検出ON/OFF（ショートカット可）、一時停止タイマー（例：30/60/90分）。
* 感度・閾値、通知の種類（ポップアップ/音/バイブなし）、サイレント時間帯。
* データ保持期間（例：7/30/90日）、**完全削除**機能。
* プロファイル（静音室/オフィス/カフェ）。
* 検出ON/OFF（ボタン/メニュー）、一時停止タイマー（例：30/60/90分）。
* 感度・閾値、通知の種類（ポップアップ/音）、サイレント時間帯。
* データ保持期間（例：7/30/90日）、**完全削除**機能。
* プロファイル（静音室/オフィス/カフェ）。

### 6.5 ログ/保存
* **メタデータのみ**保存（時刻、状態、スコア、設定、口開き指標（MAR等））。
* CSV/JSONエクスポート。
* （任意）自己学習用の**匿名ベクトル**保存。

## 7. 非機能要件

* **性能**：

  * 推論遅延：<100ms（実時間処理）
  * CPU使用率：<10〜15%（一般的ノートPC想定）
  * メモリ：<300MB

* **信頼性**：連続稼働8時間以上、例外復帰、自動再接続。
* **セキュリティ/プライバシー**：録音は既定OFF、送信なし、暗号化保存（必要時）。
* **アクセシビリティ**：色覚配慮、キーボード操作、文字サイズ可変。
* **ローカリゼーション**：日本語/英語UI。

## 8. アーキテクチャ（MVP）

* **フロント/UI**：Python（tkinter, PyQt, Dash等）
* **信号処理/推論**：Python（Mediapipe, OpenCV, scikit-learn等）
* **モジュール**：
  * I/O層（Webカメラ入力、フレームバッファ）
  * 画像処理層（顔ランドマーク抽出、MAR算出）
  * 推論層（口開きスコアリング、状態機械）
  * アプリ層（通知、集計、保存、設定UI）

## 9. 口呼吸判定ロジック（初期版の目安）

* **前提**：環境ノイズ学習でフロアE₀を推定。
* **候補指標**：

  * 1–3kHz帯域エネルギー比↑、高周波無声音成分↑
  * 吸気/呼気周期（2–6秒）に沿うブロー音の有無
  * ZCR上昇、スペクトル傾斜の平坦化

* **フレームスコア s_t** を0–1で出力、移動平均 **ŝ_t**。
* **状態遷移**：ŝ_t≥T_highが連続L秒 → 「口呼吸」開始、ŝ_t≤T_lowがM秒 → 終了。
* **デバイス/環境プロファイル**でT/L/Mを可変。

## 10. Webカメラ拡張（Phase2）

## 10. Webカメラ判定（MVP）

* **顔ランドマーク**（唇上下の距離/開口比MAR）で**口開き状態**を推定。
* マスク着用検出/顔非検出時は無効化。
* カメラ映像は**処理後即破棄**（保存しない方針）。

## 11. 音響・ハイブリッド拡張（Phase2以降）

* **音響×映像のLate Fusion**（AND/OR/重み付き投票）で精度向上。

## 11. キャリブレーション

* 30–60秒のガイド：

  * 鼻呼吸・口呼吸をそれぞれ実演 → しきい値自動調整。

* テスト結果をプレビュー（誤検知/見逃しが多い場合の提案）。

## 12. 指標/評価

* **オンライン指標**：1時間あたり通知回数、連続口呼吸時間中央値、割合。
* **精度評価**（社内/任意参加協力）：

  * 疑似正解（自己申告ボタン/映像ラベル）で**Precision/Recall/F1**推定。

* **UX指標**：1週間継続率、通知の満足度、無視率。

## 13. 設定・ポリシー

* 初回起動で**同意**（ローカル処理/保存方針/送信なし）。
* 年齢・医療注意（診断目的ではない旨の免責）。
* データ削除権、エクスポート機能。

## 14. 画面/UI（MVP）

* **ミニウィジェット**：現在状態（鼻/口/不明）、スコアバー、停止ボタン。
* **ダッシュボード**：

  * 今日のサマリー、10分粒度のタイムライン、設定ショートカット。

* **設定**：入力デバイス、感度、通知条件、プライバシー、保持期間、プロファイル。
* **設定**：カメラデバイス選択、感度、通知条件、プライバシー、保持期間、プロファイル。

## 15. ログ/データ仕様（例）

* `session_id, timestamp, state(nasal/mouth/unknown), score(0-1), noise_floor, device_id, profile, event(start/end)`
* `session_id, timestamp, state(nasal/mouth/unknown), score(0-1), MAR, device_id, profile, event(start/end)`
* CSV/JSONで日毎にローテーション。保持は既定30日。

## 16. 互換性/外部連携（将来）

* Webhook/ローカルポートで**外部アプリ通知**（例：集中タイマー、姿勢アプリ）。
* Apple/Googleヘルス連携（OS対応後）。

## 17. セキュリティ・法務

* 全処理ローカル、**クラウド送信なし**。
* 保存データはユーザー選択で暗号化。
* 第三者提供なし、広告なし（方針明記）。

## 18. リスクと軽減策

* **誤検知**（タイピング音/送風/話し声）：ノイズプロファイル＆キーボード検知（高域パターン）で抑制。
* **見逃し**（極小音・離席）：マイク感度モニター、離席検知（無音/顔不在）で状態「不明」へ。
* **端末差**：初回キャリブレーション、プロファイル保存。
* **プライバシー懸念**：録音保存OFF既定、透明な設定UI。

## 19. 開発計画（例）

* **Week 1–2**：PoC（音取得→特徴→しきい値判定→リアルタイムUI）
* **Week 3–4**：通知/ログ/日次サマリ、設定画面、デバイス選択
* **Week 5–6**：キャリブレーション、感度プロファイル、安定化
* **Week 7+**（拡張）：Webカメラ、Fusion、自己学習

## 20. 受け入れ基準（MVP）

* 連続8時間の常駐でクラッシュ/フリーズなし。
* タイピング/会話/送風を含む一般的環境で**偽陽性率 ≤10%**を初期目標。
* 通知条件（例：30秒連続）が**設定通り**に動作。
* 日次画面に**総モニタ時間/口呼吸時間/割合**が表示され、CSV出力できる。
* プライバシーモードで**音声未保存**が確認できる。